<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dashboard ‚Äî Parkinson's Voice Detector</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 24px auto; background:#f8f9fa; padding:10px; }
    button { padding:8px 14px; margin:6px; cursor:pointer; border:none; border-radius:6px; }
    #recordBtn { background:#007bff; color:white; }
    #uploadBtn { background:#28a745; color:white; }
    #logoutBtn { background:#dc3545; color:white; float:right; }
    #reportBtn { background:#6f42c1; color:white; }
    h2 { color:#333; }
    pre { background:#fff; padding:10px; border:1px solid #ddd; border-radius:6px; overflow:auto; }
  </style>
</head>
<body>
<h2>Dashboard</h2>
<button id="logoutBtn">Logout</button>

<section>
  <h3>üéôÔ∏è Record your voice (3‚Äì5 seconds)</h3>
  <p>Press record and say a long ‚Äúaaah‚Äù for about 4 seconds.</p>
  <button id="recordBtn">Start Recording</button>
  <button id="uploadBtn" disabled>Upload Recording</button>
  <button id="reportBtn" style="display:none;">üìÑ Download Report (PDF)</button>
  <p id="status"></p>
</section>

<section>
  <h3>üß† Latest Result</h3>
  <div id="latest"></div>
</section>

<section>
  <h3>üìà Your Timeline</h3>
  <canvas id="timelineChart" width="800" height="250"></canvas>
</section>

<script>
/* ---------- FIREBASE CONFIG ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyAoddqc3ahy_Q-hUI9HjRlLEBmdSrmwdHs",
  authDomain: "gdg0111.firebaseapp.com",
  projectId: "gdg0111",
  storageBucket: "gdg0111.firebasestorage.app",
  messagingSenderId: "737666672090",
  appId: "1:737666672090:web:164d2009a53b41af648ce3",
  measurementId: "G-C8P93S26XE"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

/* ---------- LOGOUT ---------- */
document.getElementById('logoutBtn').addEventListener('click', ()=>{
  auth.signOut().then(()=> location.href='index.html');
});

/* ---------- RECORDING ---------- */
let mediaRecorder;
let recordedBlob;

document.getElementById('recordBtn').addEventListener('click', async ()=>{
  document.getElementById('status').innerText = "Requesting microphone...";
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    const chunks = [];
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = async () => {
      recordedBlob = new Blob(chunks, { type: 'audio/wav' });
      document.getElementById('status').innerText = "‚úÖ Recording complete. Click Upload to analyze.";
      document.getElementById('uploadBtn').disabled = false;
    };
    mediaRecorder.start();
    document.getElementById('status').innerText = "üé§ Recording... please speak 'aaah' for 4 seconds.";
    setTimeout(()=> mediaRecorder.stop(), 4000);
  } catch(err) {
    alert("Microphone access denied or not available.");
    console.error(err);
  }
});

/* ---------- UPLOAD & ANALYZE ---------- */
document.getElementById('uploadBtn').addEventListener('click', async ()=>{
  if (!recordedBlob) return alert("Record your voice first!");
  document.getElementById('status').innerText = "Uploading... please wait ‚è≥";

  const user = auth.currentUser;
  if (!user) return alert("Please login again.");
  const idToken = await user.getIdToken(true);  // get fresh token

  const file = new File([recordedBlob], `voice-${Date.now()}.wav`, { type: 'audio/wav' });
  const form = new FormData();
  form.append('file', file);

  try {
    const resp = await fetch('http://127.0.0.1:8000/upload', {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + idToken },
      body: form
    });
    const data = await resp.json();
    if (resp.ok) {
      document.getElementById('status').innerText = "‚úÖ Uploaded successfully. Result received.";
      const display = `<b>Result:</b> ${data.label}<br><b>Confidence:</b> ${(data.score*100).toFixed(1)}%`;
      document.getElementById('latest').innerHTML = display + "<pre>" + JSON.stringify(data.features, null, 2) + "</pre>";
      document.getElementById('reportBtn').style.display = "inline-block"; // show PDF button
      loadTimeline(); // refresh chart
    } else {
      document.getElementById('status').innerText = "‚ùå Error: " + (data.detail || 'Failed');
      console.error(data);
    }
  } catch(err) {
    document.getElementById('status').innerText = "‚ùå Upload failed. Check backend connection.";
    console.error(err);
  }
});

/* ---------- DOWNLOAD REPORT ---------- */
document.getElementById('reportBtn').addEventListener('click', async ()=>{
  const user = auth.currentUser;
  if (!user) return alert("Please login first.");
  const idToken = await user.getIdToken(true);
  try {
    const resp = await fetch('http://127.0.0.1:8000/generate_report', {
      method: 'POST',
      headers: { 
        'Authorization': 'Bearer ' + idToken,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({})
    });
    if (!resp.ok) throw new Error("Failed to generate report");
    const blob = await resp.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "Voice_Analysis_Report.pdf";
    document.body.appendChild(a);
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);
  } catch(err) {
    alert("Report generation failed. Check backend.");
    console.error(err);
  }
});

/* ---------- TIMELINE CHART ---------- */
async function loadTimeline(){
  const user = auth.currentUser;
  if (!user) return;
  const idToken = await user.getIdToken(true);
  try {
    const resp = await fetch('http://127.0.0.1:8000/user/results', {
      headers: { 'Authorization': 'Bearer ' + idToken }
    });
    const data = await resp.json();
    const results = data.results || [];
    if (!results.length) return;

    const labels = results.map(r => new Date(r.created_at).toLocaleString()).reverse();
    const scores = results.map(r => r.score).reverse();
    const ctx = document.getElementById('timelineChart').getContext('2d');
    if (window.timelineChart) window.timelineChart.destroy();
    window.timelineChart = new Chart(ctx, {
      type: 'line',
      data: { 
        labels, 
        datasets: [{ 
          label:'Parkinson Risk Score', 
          data: scores, 
          fill:false,
          borderColor:'#007bff',
          tension:0.1 
        }] 
      },
      options: { scales: { y: { min:0, max:1 } } }
    });
  } catch(err) {
    console.error("Error loading timeline", err);
  }
}

/* ---------- AUTH STATE ---------- */
auth.onAuthStateChanged(user=>{
  if (!user) { window.location.href = 'login.html'; return; }
  loadTimeline();
});
</script>
</body>
</html>
